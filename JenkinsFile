pipeline {
    agent any

    // Node.js ë„êµ¬ê°€ Jenkins Toolsì— ìˆìœ¼ë©´ ì‚¬ìš© (ì—†ìœ¼ë©´ Verify ë‹¨ê³„ì—ì„œ ì‹¤íŒ¨)
    tools {
        nodejs 'NodeJS-18'
    }

    parameters {
        choice(
            name: 'DEPLOY_ENV',
            choices: ['dev', 'prd'],
            description: 'ë°°í¬ í™˜ê²½ì„ ì„ íƒí•˜ì„¸ìš”'
        )
        booleanParam(
            name: 'DEPLOY_ENABLED',
            defaultValue: false,
            description: 'ë¹Œë“œ í›„ ë¡œì»¬ ë°°í¬(íŒŒì¼ ë³µì‚¬)ë¥¼ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?'
        )
    }

    environment {
        PROJECT_NAME = 'vue-project'
        PROJECT_VERSION = '1.0.0'

        // âœ… ë¡œì»¬ ë°°í¬ ê²½ë¡œ (ì›í•˜ëŠ” ê²½ë¡œë¡œ ë°”ê¿”ì„œ ì“°ê¸°)
        DEV_LOCAL_DEPLOY_PATH = 'C:/deploy/ehub_mobile-kpi/dev'
        PRD_LOCAL_DEPLOY_PATH = 'C:/deploy/ehub_mobile-kpi/prd'

        // ë°±ì—… ë³´ê´€ ìœ„ì¹˜ (ì„ íƒ)
        BACKUP_ROOT = 'C:/deploy/_backup'
    }

    stages {

        stage('Checkout') {
            steps {
                echo "ğŸ“¥ ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ"
                checkout scm
            }
        }

        stage('Verify Environment') {
            steps {
                echo "ğŸ” í™˜ê²½ ê²€ì¦ (Windows)"
                bat '''
                    @echo on
                    where node
                    node --version
                    where npm
                    npm --version
                    where robocopy
                    robocopy /?
                '''
            }
        }

        stage('Install Dependencies') {
            steps {
                echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜"
                bat '''
                    @echo on
                    npm ci
                '''
            }
        }

        stage('Build') {
            steps {
                script {
                    echo "ğŸ”¨ ë¹Œë“œ ì‹œì‘: ${params.DEPLOY_ENV} í™˜ê²½"
                    echo "ğŸ“¦ Vite + Vue + Pinia + Router"

                    if (params.DEPLOY_ENV == 'dev') {
                        bat '@echo on
                        npm run build:dev'
                    } else {
                        bat '@echo on
                        npm run build:prd'
                    }
                }
            }
        }

        stage('Archive Artifacts') {
            steps {
                echo "ğŸ“ ë¹Œë“œ ê²°ê³¼ë¬¼ ì•„ì¹´ì´ë¸Œ"
                archiveArtifacts artifacts: 'dist/**/*', fingerprint: true
            }
        }

        stage('Deploy (Local Copy)') {
            when {
                expression { return params.DEPLOY_ENABLED == true }
            }
            steps {
                script {
                    def deployPath = (params.DEPLOY_ENV == 'dev')
                            ? env.DEV_LOCAL_DEPLOY_PATH
                            : env.PRD_LOCAL_DEPLOY_PATH

                    echo "ğŸš€ ë¡œì»¬ ë°°í¬ ì‹œì‘: ${deployPath}"

                    // dist ì¡´ì¬ ì²´í¬ + ë°°í¬ í´ë” ìƒì„± + ë°±ì—… + ë™ê¸°í™” ë³µì‚¬
                    bat """
                        @echo on
                        chcp 65001 >nul
                        
                        if not exist dist (
                          echo ERROR: dist í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤. ë¹Œë“œê°€ ì‹¤íŒ¨í–ˆê±°ë‚˜ ì‚°ì¶œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.
                          exit /b 1
                        )

                        rem ë°°í¬ í´ë” ì¤€ë¹„
                        if not exist "${deployPath}" mkdir "${deployPath}"

                        rem ë°±ì—…(ì„ íƒ): ê¸°ì¡´ ë°°í¬ í´ë”ë¥¼ timestampë¡œ ë°±ì—…
                        for /f "tokens=1-4 delims=:. " %%a in ("%TIME%") do set HH=%%a& set MN=%%b& set SS=%%c
                        set TS=%DATE:~0,4%%DATE:~5,2%%DATE:~8,2%_%HH%%MN%%SS%
                        if not exist "${env.BACKUP_ROOT}" mkdir "${env.BACKUP_ROOT}"
                        if exist "${deployPath}\\*" (
                          echo Backup -> "${env.BACKUP_ROOT}\\${env.PROJECT_NAME}_${params.DEPLOY_ENV}_%TS%"
                          xcopy "${deployPath}" "${env.BACKUP_ROOT}\\${env.PROJECT_NAME}_${params.DEPLOY_ENV}_%TS%\\" /E /I /Y >nul
                        )

                        rem robocopyëŠ” ì„±ê³µí•´ë„ exit codeê°€ 1~7ì¼ ìˆ˜ ìˆìŒ(ì •ìƒ)
                        rem /MIR: distì™€ ë°°í¬í´ë”ë¥¼ ë¯¸ëŸ¬(ì‚­ì œ ë™ê¸°í™”)
                        rem /R:2 /W:2: ì¬ì‹œë„ ìµœì†Œí™”
                        robocopy "dist" "${deployPath}" /MIR /R:2 /W:2
                        set RC=%ERRORLEVEL%
                        echo robocopy exit code: %RC%

                        rem 0~7ì€ ì •ìƒ ë²”ìœ„(ë³µì‚¬/ë™ê¸°í™” ê²°ê³¼ ì½”ë“œ)
                        if %RC% GEQ 8 (
                          echo ERROR: robocopy failed with exit code %RC%
                          exit /b %RC%
                        )

                        echo âœ… ë¡œì»¬ ë°°í¬ ì™„ë£Œ
                        exit /b 0
                    """
                }
            }
        }
    }

    post {
        success {
            echo "âœ… íŒŒì´í”„ë¼ì¸ ì„±ê³µ!"
            echo "í”„ë¡œì íŠ¸: ${env.PROJECT_NAME} v${env.PROJECT_VERSION}"
            echo "í™˜ê²½: ${params.DEPLOY_ENV}"
            echo "ë°°í¬ ì—¬ë¶€: ${params.DEPLOY_ENABLED}"
        }
        failure {
            echo "âŒ íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨!"
        }
        always {
            cleanWs(cleanWhenNotBuilt: false,
                    deleteDirs: true,
                    disableDeferredWipeout: true,
                    notFailBuild: true)
        }
    }
}
